<html>
<head>
<title>Space Shooter</title>
<style>
	.widget{
		border: 1px  dotted;
		padding: 5 5 5 5;
		margin-bottom: 20;
	}
	.heading{ 
		
		margin-top: -15;
		margin-bottom: 0;
		background-color: #FFF;
		display: table;
	}
	.enemy{
		position:absolute; 
	}

	#spaceship{
		position:absolute;
	}
</style>
</head>
<body>
	Space Shooter <input type='button' onClick='startGame();' value='Play'>  	
</body>
<script type="text/javascript">
var RIGHT = 39;
var LEFT = 37;
var SPACE = 32;
var SHIPID = 'spaceship';
var LASORCLASS = 'lasor';
var LASOR = '|';
var ENEMYLASORCLASS = 'enemyLasor';
var ENEMYCLASS = 'enemy';
var ENEMIES = [];
var enemyList = ['MAVERICK', 'BLOCKADE', 'GUARD'];
for(var i = 0; i < enemyList.length; i++){
	enemyType = enemyList[i];
	ENEMIES[enemyType] = enemySpecs(enemyType);
}

var FRAMEHEIGHT = 300;
var FRAMEWIDTH = 600;
var ENEMY_MOVEX = 1;
var ENEMY_UPDATE_DELAY = 30;
var ENEMYSCOREVALUE = 100;
var MENUSCREEN = 0;
var GAMESCREEN = 1;
var GAMEOVER = 2;

var status = MENUSCREEN;
var level = 1;
var score = 0;
var delay = 10;
var lastEnemyUpdateTime = Date.now();

function processInput(event){
	console.log(event);
	if(event.keyCode == RIGHT){
		move(SHIPID, 10);
	} else 
	if (event.keyCode == LEFT){
		move(SHIPID, -10);
	} 
	else if (event.keyCode == SPACE){
		shoot();
	}
	else if (event.keyCode == 80){
		createEnemy();
	}
//	49 50 51 52

};
//space shooter functions
/*	function move
*	
*	moves element by given distance
*	+ value moves right
*	- value moves left
*/
function move(elementId, distance){
	var e = elementWithId(elementId);
	setElementMargin(e, distance);
	return true;
}

function elementWithId(id){
	return document.getElementById(id);
}

function angleBetweenElements(element1, element2){
	var e1x = parseInt(Math.abs(getElementMarginLeft(element1)));
	var e2x = parseInt(Math.abs(getElementMarginLeft(element2)));
	var e1y = parseInt(Math.abs(getElementMarginTop(element1)));
	var e2y = parseInt(Math.abs(getElementMarginTop(element2)));

	var rise = e1y - e2y;
	var run = e1x - e2x;
	var angle = -Math.atan(run/rise);
	return angle;

}

function rotateElement(element, rad){
	element.style.webkitTransform = "rotate("+rad+"rad)";
}

function elementsOfClass(className){
	return document.getElementsByClassName(className);
}

function getElementMarginLeft(element){
	return parseInt(element.style.marginLeft) || 0;
}

function getElementMarginTop(element){
	return parseInt(element.style.marginTop) || 0;
}

function setElementMargin(element, margin){
	element.style.marginLeft = getElementMarginLeft(element) + margin;
}

function createElementWithText(tag, text){
	var element = document.createElement(tag);
	element.innerHTML = text;

	return element;
}

function removeElement(element){
	element.parentNode.removeChild(element);
}

function shoot(){

	if(elementsOfClass(LASORCLASS).length >= 2) return false;
	var e = elementWithId(SHIPID);
	var lasor = createElementWithText('div', LASOR);
	lasor.style.position = 'absolute';
	lasor.style.marginLeft = '15px';
	lasor.style.marginTop = e.style.marginTop;
	lasor.className = LASORCLASS;
	setElementMargin(lasor, getElementMarginLeft(e));
	e.parentNode.insertBefore(lasor, e);

}

//ENEMIES
function getShipSprite(ship){
	return ship.sprite.ship;
}

function getFloatXRange(ship){
	return ship.range.x || 0;
}

function getFloatYRange(ship){
	return ship.range.y || 0;
}

function getEnemyClass(ship){
	return ship.className.ship;
}

function getEnemyLasor(ship){
	return ship.sprite.lasor;
}

function getElementType(element){
	return element.getAttribute("data-type");
}

function getEnemyXSpeed(ship){
	return ship.speed.x || 0;
}

function getEnemyYSpeed(ship){
	return ship.speed.y || 0;
}

function getEnemyObject(element){
	var type = getElementType(element);
	//console.log(type, ENEMIES[type]);
	return ENEMIES[type];
}


function createEnemy(type){
	type = type.toUpperCase();
	var ship = elementWithId(SHIPID);
	var enemyObj = ENEMIES[type];
	var enemy = createElementWithText('div', getShipSprite(enemyObj));
	var xorigin = (Math.random()*(FRAMEWIDTH - 2 * getFloatXRange(enemyObj))) + getFloatXRange(enemyObj);
	var yorigin = 40;

	enemy.className = getEnemyClass(enemyObj);
	enemy.setAttribute("data-originX", xorigin);
	enemy.setAttribute("data-originY", yorigin);
	enemy.setAttribute("data-dir", 0);
	enemy.setAttribute("data-type", type);
	enemy.style.marginLeft = 0;
	enemy.style.marginTop = yorigin;

	ship.parentNode.insertBefore(enemy, ship);

	return enemy;
}

function enemySpecs(enemyType){

	if(enemyType == "MAVERICK")
		return {
			sprite: {
				ship: "&#9660;",
				lasor: "*"
			},
			className: {
				ship: ENEMYCLASS,
				lasor: ENEMYLASORCLASS
			},
			range:{
				x: 50,
				y: 50
			},
			speed: {
				x: 1,
				y: 0
			}
		};
	if(enemyType == "BLOCKADE")
		return {
			sprite: {
				ship: "&#8734;",
				lasor: null
			},
			className: {
				ship: ENEMYCLASS,
				lasor: ENEMYLASORCLASS
			},
			range:{
				x: 0,
				y: 0 
			},
			speed:{
				x: 10,
				y: 0
			}
		};
	if(enemyType == "GUARD")
		return {
			sprite: {
				ship: "U",
				lasor: "."
			},
			className: {
				ship: ENEMYCLASS,
				lasor: ENEMYLASORCLASS
			},
			range:{
				x: 0,
				y: 5 
			},
			speed:{
				x: 10,
				y: 1
			}
		};
}

function enemyShoot(enemy){

	var ship = elementWithId(SHIPID);
	var angle = angleBetweenElements(enemy, ship);
	var enemyMarginTop = enemy.style.marginTop;
	var enemyMarginLeft = getElementMarginLeft(enemy);
	var enemyLasorSprite = getEnemyLasor(getEnemyObject(enemy));
	var enemyType = getElementType(enemy);

	var enemyLasor = createElementWithText('div', enemyLasorSprite);
	enemyLasor.style.position = 'absolute';
	setElementMargin(enemyLasor, enemyMarginLeft);
	enemyLasor.style.marginTop = enemyMarginTop;
	enemyLasor.className = ENEMYLASORCLASS;
	enemyLasor.setAttribute("data-angle", angle);
	enemyLasor.setAttribute("data-originY", enemyMarginTop);
	enemyLasor.setAttribute("data-originX", enemyMarginLeft);
	
	enemy.parentNode.insertBefore(enemyLasor, enemy);
}

function updateEnemyLasorPosition(){

	var nodeList = elementsOfClass(ENEMYLASORCLASS);
	for(var i = 0; i < nodeList.length; i++) {
		var lasor = nodeList[i];
		var originY = parseInt(lasor.getAttribute("data-originY"));
    	var originX = parseInt(lasor.getAttribute("data-originX"));
		var angle = lasor.getAttribute("data-angle");
    	
		
		if(getElementMarginTop(lasor) > FRAMEHEIGHT){
			removeElement(lasor);
			continue;
		}
    	
    	
    	var lasorMoveY = getElementMarginTop(lasor) + 1;
    	lasor.style.marginTop = lasorMoveY;

    	var lasorMoveX = originX + ((originY - lasorMoveY)*Math.tan(angle));
    	lasor.style.marginLeft = lasorMoveX;

	}
}

function updateLasorPosition(){
	var nodeList = elementsOfClass(LASORCLASS);
	for(var i = 0; i < nodeList.length; i++) {
		var e = nodeList[i];
		if(getElementMarginTop(e) < 0){
			removeElement(e);
			continue;
		}
    	
    	e.style.marginTop = getElementMarginTop(e) - 5;
	}
}

function updateEnemyPosition(){
	var currentTime = Date.now();
	
	var enemies = elementsOfClass(ENEMYCLASS);
	var spaceship = elementWithId(SHIPID);
	var shipX = getElementMarginLeft(spaceship);
	for(var i = 0; i < enemies.length; i++){
		var enemy = enemies[i];
		var enemyType = getElementType(enemy);
		var enemyObj = getEnemyObject(enemy);
		var enemyMoveDir = enemy.getAttribute("data-dir");

		if(enemyMoveDir != 1 && enemyMoveDir != -1){
			var dir = (Math.random() <= 0.5)? -1 : 1;
			enemy.setAttribute("data-dir", dir);
		}

		var deg = (angleBetweenElements(enemy, spaceship));
		rotateElement(enemy, deg);

		if(currentTime - lastEnemyUpdateTime > ENEMY_UPDATE_DELAY ){
			var enemyX = getElementMarginLeft(enemy);
			var enemyXOrigin = parseInt(enemy.getAttribute("data-originX"));

			if(enemyX < enemyXOrigin - getFloatXRange(enemyObj)){
				enemy.setAttribute("data-dir", "1");
			} else 
			if(enemyX > enemyXOrigin + getFloatXRange(enemyObj)){
				enemy.setAttribute("data-dir", "-1");
			}

			var newEnemyLocation =  getEnemyXSpeed(enemyObj) * enemyMoveDir;
			setElementMargin(enemy, newEnemyLocation);

			//blockade specific
			if(getElementType(enemy) == "BLOCKADE" ||getElementType(enemy) == "GUARD") {
				if(Math.abs(enemyX - enemyXOrigin) <= getEnemyXSpeed(enemyObj) )
					enemy.style.marginLeft = enemyXOrigin;
			}
			
				
		}	

		var enemyLasorSprite = getEnemyLasor(getEnemyObject(enemy));
		if(enemyLasorSprite)
			if(enemyType == "GUARD" && Math.abs(enemyX - shipX) < 50)
				enemyShoot(enemy);
			else if(Math.random() >= 0.9 && elementsOfClass(ENEMYLASORCLASS).length < elementsOfClass(ENEMYCLASS).length)
			enemyShoot(enemy);
	}
	
	if(currentTime - lastEnemyUpdateTime > ENEMY_UPDATE_DELAY )
		lastEnemyUpdateTime = Date.now();
}

function checkForHit(){
	var lasors = elementsOfClass(LASORCLASS);
	var enemyLasors = elementsOfClass(ENEMYLASORCLASS);
	var enemies = elementsOfClass(ENEMYCLASS);

	for(var i = 0; i < lasors.length; i++){
		for(var j = 0; j < enemies.length; j++){
			var currentLasor = lasors[i];
			var currentEnemy = enemies[j];

			var currentLasorX = parseInt(currentLasor.style.marginLeft) || 0;
			var currentLasorY = parseInt(currentLasor.style.marginTop) || 0;
			var currentEnemyX = parseInt(currentEnemy.style.marginLeft) || 0;
			var currentEnemyY = parseInt(currentEnemy.style.marginTop) || 0;

			if(currentLasorX > currentEnemyX - 5 && currentLasorX < currentEnemyX + 15){
				if(currentLasorY < currentEnemyY && currentLasorY > currentEnemyY - 10){
					addPoints();
					removeElement(currentEnemy);
				}
			}	
		}
	}

	if(elementsOfClass(ENEMYCLASS).length == 0){
		createNewLevel();
	}	

	for(var i = 0; i < enemyLasors.length; i++){
		var currentLasor = enemyLasors[i];
		var ship = elementWithId(SHIPID);

		var currentLasorX = parseInt(currentLasor.style.marginLeft) || 0;
		var currentLasorY = parseInt(currentLasor.style.marginTop) || 0;
		var shipX = parseInt(ship.style.marginLeft) || 0;
		var shipY = parseInt(ship.style.marginTop) || 0;

		if(currentLasorX > shipX - 5 && currentLasorX < shipX + 30){
			if(currentLasorY > shipY && currentLasorY < shipY + 10){
				//removeElement(currentEnemy);
				endGame();
				console.log("dedz");
			}
		}	
	}
}

function startGame(){
	level = 0;
	score = 0;
	status = GAMESCREEN;

	document.body.innerHTML = '<!-- Space Shooter --> '+
	'<div class="widget" style="width: '+FRAMEWIDTH+'; height: '+FRAMEHEIGHT+'"> '+
		'<div class="heading">Space Shooter</div>' +
		'<div class="gameframe">'+
			'<div id="score" style="margin-top: 15; position: absolute"> SCORE: 0 </div>' +
			'<div id="level" style="margin-top: 0; position: absolute"> LEVEL: 1 </div>' +
			'<div id="spaceship" style="margin-top: 280"> >&#9650;< </div>'+
		'</div>'+
	'</div>';
}

function endGame(){
	status = GAMEOVER;

	document.body.innerHTML = "DEDZ <input type='button' onClick='startGame();' value='replay'>";
}

function addPoints(){
	score += ENEMYSCOREVALUE;
	updateScoreBoard();
}

function createNewLevel(){
	level++;
	updateLevelBoard();
	for(var i = 0; i < level; i++){
		var enemy = randomEnemy();
		enemy.style.marginLeft = -50*i;
	}
}

function randomEnemy(){
	var enemyIndex = Math.floor(Math.random()*enemyList.length);
	return createEnemy(enemyList[enemyIndex]);
}

function updateScoreBoard(){
	var scoreboard = elementWithId("score");

	scoreboard.innerHTML = "SCORE: " + score;

}

function updateLevelBoard(){
	var scoreboard = elementWithId("level");

	scoreboard.innerHTML = "LEVEL: " + level;
}

function run(){
	
	if (status == GAMESCREEN){
		updateLasorPosition();
		updateEnemyLasorPosition()
		checkForHit();
		updateEnemyPosition();
	}
	else if(status == MENUSCREEN){
		
	}

	else if(status == GAMEOVER){

	}
}

document.addEventListener('keydown', processInput, false);
var intervalID = window.setInterval(run, delay);
</script>
</html>